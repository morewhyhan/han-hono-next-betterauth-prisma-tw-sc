# 修复系统问题和优化功能

## 1. 问题分析

通过分析代码，我发现了以下几个关键问题：

### 1.1 后端API不支持父子任务字段

* 前端尝试传递`parentId`和`period`字段创建任务

* 但后端`taskCreateSchema`和`taskUpdateSchema`没有包含这些字段

* 导致创建父子任务失败

### 1.2 任务状态管理不一致

* 前端使用了`pending_approval`状态

* 但后端`taskUpdateSchema`只允许`pending`或`completed`

* 导致任务状态更新失败

### 1.3 AI生成任务字段不完整

* AI可能生成缺少必填字段的任务数据

* 前端需要更严格的数据验证和默认值处理

### 1.4 缺少任务关联查询

* 后端API没有提供查询子任务或父任务的功能

* 不利于前端构建完整的任务树

## 2. 解决方案

### 2.1 更新后端API Schema

* 修改`taskCreateSchema`，添加`parentId`、`period`和`status`字段

* 修改`taskUpdateSchema`，添加`parentId`、`period`和支持`pending_approval`状态

* 确保前端和后端的字段定义一致

### 2.2 完善前端数据处理

* 增强前端数据验证，处理AI返回的不完整任务数据

* 添加默认值处理，确保必填字段有合理的默认值

* 优化错误处理，提供更好的用户反馈

### 2.3 增强任务API功能

* 添加查询子任务的功能

* 添加查询父任务的功能

* 支持批量操作任务

### 2.4 优化AI提示词

* 确保AI生成包含完整必填字段的任务数据

* 提供更明确的字段要求

## 3. 具体实现步骤

1. **更新后端任务API Schema**：

   * 修改`taskCreateSchema`，添加`parentId`、`period`和`status`字段

   * 修改`taskUpdateSchema`，添加`parentId`、`period`和支持`pending_approval`状态

2. **完善前端数据处理**：

   * 增强`createTaskRecursive`函数的数据验证

   * 添加默认值处理，确保必填字段有合理的默认值

   * 优化错误处理，提供更好的用户反馈

3. **增强任务API功能**：

   * 添加查询子任务的路由

   * 添加查询父任务的路由

   * 支持批量操作任务

4. **测试功能**：

   * 测试AI生成父子任务的完整流程

   * 测试任务审批流程

   * 测试任务状态更新

## 4. 预期效果

* 系统能够正常创建和管理父子任务

* 前端和后端的状态管理一致

* AI生成的任务能够正确处理

* 任务审批流程顺畅

* 系统具有良好的错误处理和用户反馈

## 5. 技术要点

* 更新Zod Schema定义

* 确保前端和后端字段一致

* 增强数据验证和默认值处理

* 添加必要的错误处理

* 优化API功能

