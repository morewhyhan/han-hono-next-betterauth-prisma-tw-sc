# 修复创建任务时的500错误

## 1. 问题分析

* **错误类型**：HTTP 500 Internal Server Error

* **错误位置**：`server/api/routes/task.ts` 的任务创建逻辑

* **根本原因**：前端发送的 `dueDate` 是字符串格式，但 Prisma 需要显式的 Date 对象

* **具体情况**：

  * 前端发送 `YYYY-MM-DDTHH:mm:ss` 格式的字符串

  * Prisma schema 中 `dueDate` 是 `DateTime?` 类型

  * Prisma 无法自动将字符串转换为 DateTime 类型

## 2. 修复方案

### 2.1 在服务器端添加日期转换

* 修改 `server/api/routes/task.ts` 中的任务创建和更新逻辑

* 在将数据传递给 Prisma 之前，将 `dueDate` 字符串转换为 Date 对象

* 使用三元表达式检查 `dueDate` 是否存在，存在则转换，否则保持 null

### 2.2 具体修改

* 在创建任务前转换 `dueDate`：`dueDate: data.dueDate ? new Date(data.dueDate) : null`

* 在更新任务前转换 `dueDate`：同样的转换逻辑

* 确保转换后的数据类型与 Prisma schema 匹配

## 3. 代码修改

### 3.1 修改创建任务的逻辑

```typescript
// 当前代码
const task = await prisma.task.create({
  data: {
    ...data,
    userId
  }
})

// 修改后
const task = await prisma.task.create({
  data: {
    ...data,
    dueDate: data.dueDate ? new Date(data.dueDate) : null,
    userId
  }
})
```

### 3.2 修改更新任务的逻辑

```typescript
// 当前代码
const task = await prisma.task.update({
  where: { id: parseInt(id), userId },
  data
})

// 修改后
const task = await prisma.task.update({
  where: { id: parseInt(id), userId },
  data: {
    ...data,
    dueDate: data.dueDate ? new Date(data.dueDate) : null,
  }
})
```

## 4. 预期结果

* 修复后，创建任务时不会再出现 500 错误

* Prisma 能够正确处理 `dueDate` 字段

* 任务能够成功保存到数据库

* 前端能够正常创建和更新任务

## 5. 验证步骤

* 运行 `npm run build` 确保项目能正常构建

* 启动开发服务器，测试手动新建任务功能

* 检查数据库中是否成功保存了新任务

* 验证任务的 `dueDate` 字段是否正确存储

