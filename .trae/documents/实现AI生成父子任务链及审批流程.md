# 实现AI生成父子任务链及审批流程

## 1. 任务分析
- **需求**：AI生成父子任务链，显示到审批页面，手动审核通过后添加到待办
- **当前问题**：
  - AI只生成单个任务，不支持父子关系
  - 任务直接添加到数据库，没有审批流程
  - 审批页面不能显示父子任务关系

## 2. 实现方案

### 2.1 修改前端AI任务生成逻辑
- **文件**：`app/(main)/home/page.tsx`
- **功能**：修改`handleTaskApproval`函数，支持创建父子任务链
- **实现**：
  - 递归处理AI生成的任务结构
  - 先创建父任务，获得父任务ID
  - 再创建子任务，关联父任务ID
  - 设置所有任务状态为`pending_approval`

### 2.2 修改审批页面
- **文件**：`app/(main)/tasks/approval/page.tsx`
- **功能**：显示父子任务关系，支持审批操作
- **实现**：
  - 构建任务树结构
  - 实现父子任务的展开/折叠功能
  - 支持批量审批操作
  - 保持与任务列表页面一致的UI风格

### 2.3 完善任务API
- **文件**：`server/api/routes/task.ts`
- **功能**：确保API支持父子任务的创建和更新

### 2.4 修改AI提示词
- **文件**：`server/api/routes/ai-task.ts`
- **功能**：确保AI生成包含子任务的任务链

## 3. 具体实现步骤

1. **修改前端任务创建逻辑**：
   - 更新`handleTaskApproval`函数，实现递归创建父子任务
   - 设置任务状态为`pending_approval`

2. **修改审批页面**：
   - 添加任务树构建逻辑
   - 实现父子任务的UI展示
   - 添加展开/折叠功能

3. **测试功能**：
   - 测试AI生成父子任务
   - 测试任务显示到审批页面
   - 测试审批通过后任务添加到待办
   - 测试审批拒绝/撤回功能

## 4. 预期效果
- AI生成的父子任务链显示在审批页面
- 支持展开/折叠查看父子任务
- 手动审批通过后，任务状态更新为`pending`并显示到待办列表
- 支持审批拒绝和撤回操作

## 5. 技术要点
- 递归处理父子任务关系
- 任务状态管理
- React组件递归渲染
- 任务树结构构建